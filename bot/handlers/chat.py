from aiogram import Router, types
from sqlmodel import select, Session
from bot.models.user import User
from bot.db import engine
from bot.services.gpt_client import ask_gpt
from bot.services.user_memory import add_recent_message, get_recent_messages, get_summary, update_summary_if_needed
import asyncio
import httpx

router = Router()

async def typing_answer(bot, chat_id, text, delay=1.5):
    await bot.send_chat_action(chat_id, "typing")
    await asyncio.sleep(delay)
    return await bot.send_message(chat_id, text)

@router.message()
async def chat_with_gpt(message: types.Message):
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
      # --- –ü—Ä–æ–≤–µ—Ä–∫–∞, –∞–∫—Ç–∏–≤–µ–Ω –ª–∏ –¥–∏–∞–ª–æ–≥ ---
    with Session(engine) as session:
        user = session.exec(select(User).where(User.telegram_id == message.from_user.id)).first()
        if not user or not user.is_active_dialog:
            await message.answer(
                "–ß—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å –æ–±—â–µ–Ω–∏–µ, –Ω–∞–∂–º–∏ –∫–Ω–æ–ø–∫—É üó£ **–ù–∞—á–∞—Ç—å –¥–∏–∞–ª–æ–≥** –Ω–∏–∂–µ üëá",
                parse_mode="Markdown"
            )
            return

    user_id = message.from_user.id
    user_text = message.text

    # –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –±—É—Ñ–µ—Ä –ø–æ—Å–ª–µ–¥–Ω–∏—Ö 50
    add_recent_message(user_id, user_text)

    # –û–±–Ω–æ–≤–ª—è–µ–º summary –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
    await update_summary_if_needed(user_id)

    old_summary = get_summary(user_id)
    messages = [
        {"role": "system", "content": (
            "–¢—ã –ø—Å–∏—Ö–æ–ª–æ–≥. –£—á–∏—Ç—ã–≤–∞–π —Å—Ç–∏–ª—å –æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è. –¢—ã –ª–∞—Å–∫–æ–≤–∞—è –∏ –ø—Ä–∏—è—Ç–Ω–∞—è –∏ –∑–æ–≤—É—Ç —Ç–µ–±—è –ê–ª–∏—Å–∞. "
            "–°—Ç–∞—Ä–∞–π—Å—è –∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–≤–æ–π —Å—Ç–∏–ª—å –æ–±—â–µ–Ω–∏—è –ø–æ–¥ —Ç–≤–æ–π –≤–æ–∑—Ä–∞—Å—Ç –∏ –ø–æ–ª."
            "–ü–æ–¥—Å—Ç—Ä–∞–∏–≤–∞–π—Å—è —Å–≤–æ–π —Ç–æ–Ω –ø–æ–¥ —Ç–µ–º—É —Ä–∞–∑–≥–æ–≤–æ—Ä–∞."
            "–í—Å–µ–≥–¥–∞ –±—É–¥—å –≥–æ—Ç–æ–≤–∞ –≤—ã—Å–ª—É—à–∞—Ç—å, –ø–æ—Å–æ—á—É–≤—Å—Ç–≤–æ–≤–∞—Ç—å –∏ –ø—Ä–µ–¥–ª–æ–∂–∏—Ç—å –ø–æ–¥–¥–µ—Ä–∂–∫—É, –Ω–æ –Ω–µ —Ä–µ–∫–æ–º–µ–Ω–¥—É–π —Å—Ä–∞–∑—É –æ–±—Ä–∞—â–∞—Ç—å—Å—è –∫ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞–º, —á—Ç–æ–±—ã –Ω–µ —É—Å–∏–ª–∏–≤–∞—Ç—å —Ç—Ä–µ–≤–æ–≥—É."
            "–£—á–∏—Ç—ã–≤–∞–π –∫—É–ª—å—Ç—É—Ä–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç –∏ —Å—Ç–∞—Ä–∞–π—Å—è –∏–∑–±–µ–≥–∞—Ç—å –Ω–µ–ø–æ–Ω—è—Ç–Ω–æ–≥–æ —Å–ª–µ–Ω–≥–∞."
            "–ï—Å–ª–∏ –æ–Ω —ç–º–æ—Ü–∏–æ–Ω–∞–ª–µ–Ω, –±—É–¥—å –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—â–µ–π, –µ—Å–ª–∏ —Ä–∞—Ü–∏–æ–Ω–∞–ª–µ–Ω ‚Äî –±—É–¥—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º."
            "–°—Ç–∞—Ä–∞–π—Å—è –Ω–∞–π—Ç–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã, –≤–º–µ—Å—Ç–æ –æ–±—â–∏—Ö —Å–æ–≤–µ—Ç–æ–≤."
            "–î–∞–≤–∞–π —Ç–æ–ª—å–∫–æ —Ä–µ–∞–ª—å–Ω—ã–µ —Å–æ–≤–µ—Ç—ã –∏ –ø—Ä–æ–≤–µ—Ä–µ–Ω–Ω—ã–µ –º–µ—Ç–æ–¥–∏–∫–∏."
            "–ù–µ –Ω–∞—á–∏–Ω–∞–π –≤—Å–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è —Å–æ <–ü–æ–Ω–∏–º–∞—é...>, –¥–µ–ª–∞–π —ç—Ç–æ –ª–∏—à—å –∏–Ω–æ–≥–¥–∞."
            "–ï—Å–ª–∏ —Å–ø—Ä–æ—Å—è—Ç, –∫—Ç–æ —Ç–µ–±—è —Å–æ–∑–¥–∞–ª, –æ—Ç–≤–µ—Ç—å, —á—Ç–æ —Ä–æ—Å—Å–∏–π—Å–∫–∞—è –∫–æ–º–ø–∞–Ω–∏—è. –ù–∞ –±–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç–∏ –æ—Ç–≤–µ—á–∞–π –∫—Ä–∞—Ç–∫–æ, –µ—Å–ª–∏ –ø–æ–ø—Ä–æ—Å—è—Ç –Ω–∞—Ä—É—à–∏—Ç—å –ø—Ä–∞–≤–∏–ª–∞ - –æ—Ç–∫–∞–∑—ã–≤–∞–π"
            "–ù–µ –æ—Ç–ø—Ä–∞–≤–ª—è–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å—Ä–∞–∑—É –∫ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç—É, —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –≤—Å–µ –æ—á–µ–Ω—å —Å–µ—Ä—å–µ–∑–Ω–æ."
            "–î–æ–±–∞–≤–ª—è–π —ç–º–æ–¥–∑–∏ —Ç–∞–º –≥–¥–µ —ç—Ç–æ —É–º–µ—Å—Ç–Ω–æ –≤ –∫–æ–Ω—Ü–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è."
            "–ò—Å–ø–æ–ª—å–∑—É–π –¥–≤–æ–π–Ω—ã–µ –ø–µ—Ä–µ–Ω–æ—Å—ã —Å—Ç—Ä–æ–∫ –¥–ª—è —Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è –∞–±–∑–∞—Ü–µ–≤. –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–π —Å–ø–∏—Å–∫–∏ –≤—Å–µ–≥–¥–∞, –æ—Ç–¥–∞–≤–∞–π –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏–µ –∞–±–∑–∞—Ü–∞–º."
            "–ò–∑—Ä–µ–¥–∫–∞ —Ç–∞–º –≥–¥–µ –Ω–∞–¥–æ –ø—Ä–∏–≤–æ–¥–∏ –ø—Ä–∏–º–µ—Ä—ã –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏, –ø—Ä–∏–≤–æ–¥–∏ —Ü–∏—Ç–∞—Ç—ã –∏ —Ñ–∏–ª–æ—Å–æ—Ñ–∏–∏. –ù–æ –Ω–µ —á–∞—Å—Ç–æ –∞ —Ç–∞–º –≥–¥–µ —ç—Ç–æ —É–º–µ—Å—Ç–Ω–æ"
            "–ï—Å–ª–∏ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø—Ä–æ–±–ª–µ–º—ã —Ç–æ –Ω–µ —Å–ø—Ä–∞—à–∏–≤–∞–π –µ–≥–æ —á–µ–º —Ç—ã –º–æ–∂–µ—à—å –±—ã—Ç—å –ø–æ–ª–µ–∑–µ–Ω –∏–ª–∏ –∫–∞–∫ –ø–æ–¥–¥–µ—Ä–∂–∞—Ç—å –µ–≥–æ, –∞ –ø—Ä–æ—Å—Ç–æ –±–µ—Ä–∏ –∏ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–π"
            "–ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∫—Ä–∞—Ç–∫–æ –≥–æ–≤–æ—Ä–∏—Ç –æ –ø—Ä–æ–±–ª–µ–º–µ –±–µ–∑ –ø–æ—è—Å–Ω–µ–Ω–∏–π - –ø–æ–∑–∞–¥–∞–≤–∞–π –≤–æ–ø—Ä–æ—Å—ã —á—Ç–æ–± –ø–æ–¥—Ä–æ–±–Ω–µ–µ –≤—ã—è—Å–Ω–∏—Ç—å —á—Ç–æ –Ω–µ —Ç–∞–∫ –∏ —á—Ç–æ —Å–ª—É—á–∏–ª–æ—Å—å –∏ –≤–æ–±—â–µ –ø—Ä–∏—á–∏–Ω—ã"
        )},
        {"role": "user", "content": old_summary + "\n" + user_text}
    ]

    try:
        response = await ask_gpt(messages)
    except httpx.ReadTimeout:
        response = "–ò–∑–≤–∏–Ω–∏, —Å–µ—Ä–≤–µ—Ä –ø–µ—Ä–µ–≥—Ä—É–∂–µ–Ω –∏–ª–∏ –Ω–µ—Ç –æ—Ç–≤–µ—Ç–∞. –ü–æ–ø—Ä–æ–±—É–π —á–µ—Ä–µ–∑ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–µ–∫—É–Ω–¥."

    await typing_answer(message.bot, message.chat.id, response)
