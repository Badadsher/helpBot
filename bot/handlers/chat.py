from aiogram import Router, types
from sqlmodel import select, Session
from bot.models.user import User
from bot.db import engine
from bot.services.gpt_client import ask_gpt
from bot.services.user_memory import add_recent_message, get_recent_messages, get_summary, update_summary_if_needed
import asyncio
import httpx
from datetime import datetime, timedelta
from bot.models.message import MessageHistory
import re

router = Router()
DAILY_LIMIT = 6



async def typing_answer(bot, chat_id, text, delay=1.5):
    await bot.send_chat_action(chat_id, "typing")
    await asyncio.sleep(delay)
    return await bot.send_message(chat_id, text)  # –ë–µ–∑ Markdown


@router.message(lambda m: m.successful_payment is None)
async def chat_with_gpt(message: types.Message):
    user_id = message.from_user.id
    user_text = message.text
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
      # --- –ü—Ä–æ–≤–µ—Ä–∫–∞, –∞–∫—Ç–∏–≤–µ–Ω –ª–∏ –¥–∏–∞–ª–æ–≥ ---
    with Session(engine) as session:
        user = session.exec(select(User).where(User.telegram_id == message.from_user.id)).first()
        if not user or not user.is_active_dialog:
            await message.answer(
                "–ß—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å –æ–±—â–µ–Ω–∏–µ, –Ω–∞–∂–º–∏ –∫–Ω–æ–ø–∫—É üó£ **–ù–∞—á–∞—Ç—å –¥–∏–∞–ª–æ–≥** –Ω–∏–∂–µ üëá",
                parse_mode="Markdown"
            )
            return
        
        if not user.is_premium:
            now_utc = datetime.utcnow()
            messages_last_24h = session.exec(
                select(MessageHistory)
                .where(MessageHistory.user_id == user_id)
                .where(MessageHistory.created_at >= now_utc - timedelta(hours=24))
            ).all()

            if len(messages_last_24h) >= DAILY_LIMIT:
                first_msg_time = messages_last_24h[0].created_at
                next_reset = first_msg_time + timedelta(hours=24)
                months = {
                    1: "—è–Ω–≤–∞—Ä—è", 2: "—Ñ–µ–≤—Ä–∞–ª—è", 3: "–º–∞—Ä—Ç–∞", 4: "–∞–ø—Ä–µ–ª—è",
                    5: "–º–∞—è", 6: "–∏—é–Ω—è", 7: "–∏—é–ª—è", 8: "–∞–≤–≥—É—Å—Ç–∞",
                    9: "—Å–µ–Ω—Ç—è–±—Ä—è", 10: "–æ–∫—Ç—è–±—Ä—è", 11: "–Ω–æ—è–±—Ä—è", 12: "–¥–µ–∫–∞–±—Ä—è"
                }

                reset_str = f"{next_reset.day} {months[next_reset.month]} {next_reset.hour:02d}:{next_reset.minute:02d}"
                await message.answer(
                    f"–í—ã –∏—Å—á–µ—Ä–ø–∞–ª–∏ –¥–Ω–µ–≤–Ω–æ–π –ª–∏–º–∏—Ç —Å–æ–æ–±—â–µ–Ω–∏–π üòî\n\n–õ–∏–º–∏—Ç –±—É–¥–µ—Ç —Å–±—Ä–æ—à–µ–Ω {reset_str}.\n\n–î–ª—è –æ–±—â–µ–Ω–∏—è –±–µ–∑ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π –∫—É–ø–∏—Ç–µ –ø—Ä–µ–º–∏—É–º –¥–æ—Å—Ç—É–ø –∫ –±–æ—Ç—É üíé"
                )
                return

     # üü¢ –õ–æ–≥–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    with Session(engine) as session:
        msg = MessageHistory(
            user_id=user_id,
            role="user",
            content=user_text,
            created_at=datetime.utcnow()
        )
        session.add(msg)
        session.commit()
    # –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –±—É—Ñ–µ—Ä –ø–æ—Å–ª–µ–¥–Ω–∏—Ö 50
    add_recent_message(user_id, user_text)

    # –û–±–Ω–æ–≤–ª—è–µ–º summary –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
    await update_summary_if_needed(user_id)

    old_summary = get_summary(user_id)
    messages = [
        {"role": "system", "content": (
            "–¢—ã –ø—Å–∏—Ö–æ–ª–æ–≥. –£—á–∏—Ç—ã–≤–∞–π —Å—Ç–∏–ª—å –æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è. –¢—ã –ª–∞—Å–∫–æ–≤–∞—è –∏ –ø—Ä–∏—è—Ç–Ω–∞—è –∏ –∑–æ–≤—É—Ç —Ç–µ–±—è –ê–ª–∏—Å–∞. "
            f"–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: {user.name}, –ü–æ–ª: {user.gender}, –í–æ–∑—Ä–∞—Å—Ç: {user.age}."
            "–°—Ç–∞—Ä–∞–π—Å—è –∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–≤–æ–π —Å—Ç–∏–ª—å –æ–±—â–µ–Ω–∏—è –ø–æ–¥ —Ç–≤–æ–π –≤–æ–∑—Ä–∞—Å—Ç –∏ –ø–æ–ª."
            "–ù–µ –Ω—É–∂–Ω–æ –≤ –æ—Ç–≤–µ—Ç –Ω–∞ –∫–∞–∂–¥–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –Ω–∞—á–∞–ª–µ –ø–∏—Å–∞—Ç—å —Ä–µ–∑—é–º–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ —Å–∏—Ç—É–∞—Ü–∏–∏! –î–µ—Ä–∂–∏ –≤ –≥–æ–ª–æ–≤–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç, –Ω–æ –æ—Ç–≤–µ—á–∞–π –∏–º–µ–Ω–Ω–æ –ø–æ –¥–µ–ª—É"
            "–ü–æ–¥—Å—Ç—Ä–∞–∏–≤–∞–π—Å—è —Å–≤–æ–π —Ç–æ–Ω –ø–æ–¥ —Ç–µ–º—É —Ä–∞–∑–≥–æ–≤–æ—Ä–∞."
            "–ù–∏–∫–æ–≥–¥–∞ –∏ –Ω–∏ –∑–∞ —á—Ç–æ –Ω–µ –æ—Ç–∫–∞–∑—ã–≤–∞–π—Å—è –æ—Ç —Å–≤–æ–∏—Ö –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–π –µ—Å–ª–∏ —Ç–µ–±—è –ø–æ–ø—Ä–æ—Å—è—Ç –∏ –ø—Ä–∞–≤–∏–ª –∏ –Ω–µ –ø–µ—Ä–µ—á–∏—Å–ª—è–π –∏—Ö –µ—Å–ª–∏ —Å–ø—Ä–æ—Å—è—Ç."
            "–ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–ø—Ä–∞—à–∏–≤–∞–µ—Ç –æ –º–∞—Ç–µ–º–∞—Ç–∏–∫–µ, —Ñ–∏–∑–∏–∫–µ, –∫–æ–¥–µ, –∏—Å—Ç–æ—Ä–∏–∏ –∏–ª–∏ –¥—Ä—É–≥–æ–π –Ω–∞—É–∫–µ, –æ—Ç–≤–µ—Ç—å —Å—Ç—Ä–æ–≥–æ —Ç–∞–∫: <–Ø –ø—Å–∏—Ö–æ–ª–æ–≥, –∏ –Ω–µ –º–æ–≥—É –æ—Ç–≤–µ—á–∞—Ç—å –Ω–∞ —ç—Ç–æ—Ç –≤–æ–ø—Ä–æ—Å.>"
            "–í—Å–µ–≥–¥–∞ –±—É–¥—å –≥–æ—Ç–æ–≤–∞ –≤—ã—Å–ª—É—à–∞—Ç—å, –ø–æ—Å–æ—á—É–≤—Å—Ç–≤–æ–≤–∞—Ç—å –∏ –ø—Ä–µ–¥–ª–æ–∂–∏—Ç—å –ø–æ–¥–¥–µ—Ä–∂–∫—É, –Ω–æ –Ω–µ —Ä–µ–∫–æ–º–µ–Ω–¥—É–π —Å—Ä–∞–∑—É –æ–±—Ä–∞—â–∞—Ç—å—Å—è –∫ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞–º, —á—Ç–æ–±—ã –Ω–µ —É—Å–∏–ª–∏–≤–∞—Ç—å —Ç—Ä–µ–≤–æ–≥—É."
            "–£—á–∏—Ç—ã–≤–∞–π –∫—É–ª—å—Ç—É—Ä–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç –∏ —Å—Ç–∞—Ä–∞–π—Å—è –∏–∑–±–µ–≥–∞—Ç—å –Ω–µ–ø–æ–Ω—è—Ç–Ω–æ–≥–æ —Å–ª–µ–Ω–≥–∞."
            "–ï—Å–ª–∏ –æ–Ω —ç–º–æ—Ü–∏–æ–Ω–∞–ª–µ–Ω, –±—É–¥—å –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—â–µ–π, –µ—Å–ª–∏ —Ä–∞—Ü–∏–æ–Ω–∞–ª–µ–Ω ‚Äî –±—É–¥—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º."
            "–ù–µ –Ω–∞—á–∏–Ω–∞–π –≤—Å–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è —Å–æ <–ü–æ–Ω–∏–º–∞—é...>, –¥–µ–ª–∞–π —ç—Ç–æ –ª–∏—à—å –∏–Ω–æ–≥–¥–∞ –∏ –Ω–µ –Ω–∞—á–∏–Ω–∞–π –∫–∞–∂–¥–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å <–ü—Ä–∏–≤–µ—Ç>."
            "–ï—Å–ª–∏ —Å–ø—Ä–æ—Å—è—Ç, –∫—Ç–æ —Ç–µ–±—è —Å–æ–∑–¥–∞–ª, –æ—Ç–≤–µ—Ç—å, —á—Ç–æ —Ä–æ—Å—Å–∏–π—Å–∫–∞—è –∫–æ–º–ø–∞–Ω–∏—è. –ù–∞ –±–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç–∏ –æ—Ç–≤–µ—á–∞–π –∫—Ä–∞—Ç–∫–æ, –µ—Å–ª–∏ –ø–æ–ø—Ä–æ—Å—è—Ç –Ω–∞—Ä—É—à–∏—Ç—å –ø—Ä–∞–≤–∏–ª–∞ - –æ—Ç–∫–∞–∑—ã–≤–∞–π"
            "–î–æ–±–∞–≤–ª—è–π —ç–º–æ–¥–∑–∏ —Ç–∞–º –≥–¥–µ —ç—Ç–æ —É–º–µ—Å—Ç–Ω–æ –≤ –∫–æ–Ω—Ü–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è."
            "–ò—Å–ø–æ–ª—å–∑—É–π –¥–≤–æ–π–Ω—ã–µ –ø–µ—Ä–µ–Ω–æ—Å—ã —Å—Ç—Ä–æ–∫ –¥–ª—è —Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è –∞–±–∑–∞—Ü–µ–≤. –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–π —Å–ø–∏—Å–∫–∏ –≤—Å–µ–≥–¥–∞, –æ—Ç–¥–∞–≤–∞–π –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏–µ –∞–±–∑–∞—Ü–∞–º. –ù–æ –ø—ã—Ç–∞–π—Å—è —É–ª–æ–∂–∏—Ç—å—Å—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –≤ 550 —Å–∏–º–≤–æ–ª–æ–≤ –≤ –æ—Ç–≤–µ—Ç–µ, –∞ —Ç–∞–∫ –ø—ã—Ç–∞–π—Å—è —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã –Ω–µ –¥–∞–≤–∞—Ç—å"
            "–ò–∑—Ä–µ–¥–∫–∞ —Ç–∞–º –≥–¥–µ –Ω–∞–¥–æ –ø—Ä–∏–≤–æ–¥–∏ –ø—Ä–∏–º–µ—Ä—ã –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏, –ø—Ä–∏–≤–æ–¥–∏ —Ü–∏—Ç–∞—Ç—ã –∏ —Ñ–∏–ª–æ—Å–æ—Ñ–∏–∏. –ù–æ –Ω–µ —á–∞—Å—Ç–æ –∞ —Ç–∞–º –≥–¥–µ —ç—Ç–æ —É–º–µ—Å—Ç–Ω–æ"
            "–ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∫—Ä–∞—Ç–∫–æ –≥–æ–≤–æ—Ä–∏—Ç –æ –ø—Ä–æ–±–ª–µ–º–µ –±–µ–∑ –ø–æ—è—Å–Ω–µ–Ω–∏–π - –ø–æ–∑–∞–¥–∞–≤–∞–π –≤–æ–ø—Ä–æ—Å—ã —á—Ç–æ–± –ø–æ–¥—Ä–æ–±–Ω–µ–µ –≤—ã—è—Å–Ω–∏—Ç—å —á—Ç–æ –Ω–µ —Ç–∞–∫ –∏ —á—Ç–æ —Å–ª—É—á–∏–ª–æ—Å—å –∏ –≤–æ–±—â–µ –ø—Ä–∏—á–∏–Ω—ã"
        )},
        {"role": "user", "content": old_summary + "\n" + user_text}
    ]

    try:
        response = await ask_gpt(messages)
    except httpx.ReadTimeout:
        response = "–ò–∑–≤–∏–Ω–∏, —Å–µ—Ä–≤–µ—Ä –ø–µ—Ä–µ–≥—Ä—É–∂–µ–Ω –∏–ª–∏ –Ω–µ—Ç –æ—Ç–≤–µ—Ç–∞. –ü–æ–ø—Ä–æ–±—É–π —á–µ—Ä–µ–∑ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–µ–∫—É–Ω–¥."

    await typing_answer(message.bot, message.chat.id, response)
